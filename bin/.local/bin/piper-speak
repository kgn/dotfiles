#!/bin/bash
# Common Piper TTS wrapper - speaks text from stdin
# Usage: echo "text" | piper-speak [--speed 0.7] [--bg]
#   --speed  Length scale (default: 0.7, lower = faster)
#   --bg     Run in background

PIPER_VOICE="$HOME/.local/share/piper/voices/en_US-lessac-medium.onnx"
SPEED="0.7"
BACKGROUND=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --speed) SPEED="$2"; shift 2 ;;
        --bg) BACKGROUND=true; shift ;;
        *) shift ;;
    esac
done

speak() {
    local text="$1"
    local tmp_wav="/tmp/piper-speak-$$.wav"

    [ -z "$text" ] && return

    echo "$text" | piper-tts --model "$PIPER_VOICE" --length_scale "$SPEED" \
        --output_file "$tmp_wav" >/dev/null 2>&1 && pw-play "$tmp_wav"

    rm -f "$tmp_wav"
}

text=$(cat)

if $BACKGROUND; then
    speak "$text" >/dev/null 2>&1 &
else
    speak "$text"
fi

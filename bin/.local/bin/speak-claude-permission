#!/bin/bash
# Speak permission request messages using Piper TTS
# Triggered via Claude Code PermissionRequest hook

# Skip if TTS is disabled
[ "$CLAUDE_TTS_DISABLED" = "1" ] && exit 0

# Read hook input from stdin, then fork to background
input=$(cat)

# Mark that we're speaking a permission (for Stop hook coordination)
echo $$ > /tmp/speak-permission-active

(
tool_name=$(echo "$input" | jq -r '.tool_name // empty')
description=$(echo "$input" | jq -r '.tool_input.description // empty')

if [ -z "$tool_name" ]; then
    rm -f /tmp/speak-permission-active
    exit 0
fi

# Use description directly, fallback to tool name
message="Permission request: ${description:-$tool_name}"

echo "$message" | piper-speak

# Clean up marker
rm -f /tmp/speak-permission-active
) >/dev/null 2>&1 &

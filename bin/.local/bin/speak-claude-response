#!/bin/bash
# Speak Claude's last response using Piper TTS
# Triggered via Claude Code Stop hook

# Skip if TTS is disabled
[ "$CLAUDE_TTS_DISABLED" = "1" ] && exit 0

# Read hook input from stdin, then fork to background
input=$(cat)

# Skip if permission hook just spoke (avoid double-read on rejected permissions)
if [ -f /tmp/speak-permission-active ]; then
    sleep 0.5
    exit 0
fi

# Debounce: skip if we spoke within last 5 seconds
LOCKFILE="/tmp/speak-response-lock"
if [ -f "$LOCKFILE" ]; then
    if [[ "$OSTYPE" == "darwin"* ]]; then
        lock_age=$(($(date +%s) - $(stat -f %m "$LOCKFILE")))
    else
        lock_age=$(($(date +%s) - $(stat -c %Y "$LOCKFILE")))
    fi
    if [ "$lock_age" -lt 5 ]; then
        exit 0
    fi
fi
touch "$LOCKFILE"

(
transcript_path=$(echo "$input" | jq -r '.transcript_path // empty')

if [ -z "$transcript_path" ] || [ ! -f "$transcript_path" ]; then
    exit 0
fi

# Extract last assistant message that has text content
text=$(grep '"type":"assistant"' "$transcript_path" | grep '"type":"text"' | tail -1 | jq -r '.message.content[] | select(.type=="text") | .text' 2>/dev/null)

if [ -z "$text" ]; then
    exit 0
fi

# Summarize long responses with Claude CLI
if [ ${#text} -gt 200 ]; then
    summary=$(echo "Summarize this response briefly for text-to-speech (2-3 sentences max, output ONLY the summary): $text" | CLAUDE_TTS_DISABLED=1 claude --print --model haiku 2>/dev/null)

    if [ -n "$summary" ]; then
        text="$summary"
    fi
fi

echo "$text" | piper-speak
) >/dev/null 2>&1 &

#!/bin/bash
# Speak Claude's last response using Piper TTS
# Triggered via Claude Code Stop hook

# Read hook input from stdin, then fork to background
input=$(cat)

# Skip if permission hook just spoke (avoid double-read on rejected permissions)
if [ -f /tmp/speak-permission-active ]; then
    # Wait briefly for permission speech to finish, then exit
    sleep 0.5
    exit 0
fi

(
PIPER_VOICE="$HOME/.local/share/piper/voices/en_US-lessac-medium.onnx"
TMP_WAV="/tmp/speak-response-$$.wav"

transcript_path=$(echo "$input" | jq -r '.transcript_path // empty')

if [ -z "$transcript_path" ] || [ ! -f "$transcript_path" ]; then
    exit 0
fi

# Extract last assistant message that has text content
text=$(grep '"type":"assistant"' "$transcript_path" | grep '"type":"text"' | tail -1 | jq -r '.message.content[] | select(.type=="text") | .text' 2>/dev/null)

if [ -z "$text" ]; then
    exit 0
fi

# Summarize long responses with Claude CLI
if [ ${#text} -gt 200 ]; then
    summary=$(echo "Summarize this response briefly for text-to-speech (2-3 sentences max, output ONLY the summary): $text" | claude --print --model haiku 2>/dev/null)

    if [ -n "$summary" ]; then
        text="$summary"
    fi
fi

# Speak with Piper
echo "$text" | piper-tts --model "$PIPER_VOICE" --length_scale 0.8 \
    --output_file "$TMP_WAV" 2>/dev/null && pw-play "$TMP_WAV"
) &
